<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philbrook Museum Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #messages-container::-webkit-scrollbar { width: 6px; }
        #messages-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #messages-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #messages-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .chat-widget-hidden {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s ease-out;
            pointer-events: none;
        }
        .chat-widget-visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: all 0.3s ease-out;
        }
        .suggestion-chip {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .suggestion-chip:hover {
            background-color: #f0f0f0;
        }
         #image-upload-label svg {
            transition: transform 0.2s ease-in-out;
        }
        #image-upload-label:hover svg {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold text-gray-800">Welcome to the Philbrook Museum of Art</h1>
        <p class="text-gray-600 mt-4">This is a demo page. The AI-powered chatbot is in the bottom right corner.</p>
    </div>

    <div id="chat-bubble" class="fixed bottom-5 right-5 cursor-pointer bg-rose-800 p-4 rounded-full shadow-lg hover:bg-rose-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.839 8.839 0 01-4.41-1.232l-2.14 1.25a.5.5 0 01-.65-.65l1.25-2.14A8.85 8.85 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.79 14.03a6.996 6.996 0 001.565 1.565L4.1 17.94l2.25-1.325a7.002 7.002 0 004.65 1.385c3.313 0 6-2.687 6-6s-2.687-6-6-6-6 2.687-6 6c0 1.69.601 3.245 1.59 4.41l-1.325 2.25 2.345-2.63z" clip-rule="evenodd" />
        </svg>
    </div>

    <div id="chat-widget" class="fixed bottom-20 right-5 w-full max-w-sm h-[70vh] max-h-[600px] bg-white rounded-lg shadow-2xl flex flex-col chat-widget-hidden">
        <div class="bg-rose-800 text-white p-4 rounded-t-lg flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold">Philbrook Virtual Assistant</h3>
                <p class="text-sm opacity-90">Powered by Gemini</p>
            </div>
            <button id="close-widget" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div id="messages-container" class="flex-1 p-4 overflow-y-auto bg-gray-50"></div>
        
        <div id="suggestions-container" class="p-2 border-t border-gray-200 bg-white flex flex-wrap gap-2 justify-center"></div>

        <div class="p-4 border-t border-gray-200 bg-white rounded-b-lg">
            <div class="flex items-center space-x-2">
                 <label for="image-upload" id="image-upload-label" class="cursor-pointer text-gray-500 hover:text-rose-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                </label>
                <input type="text" id="message-input" placeholder="Ask a question or upload art..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-rose-600 transition">
                <button id="send-button" class="bg-rose-800 text-white p-3 rounded-full hover:bg-rose-700 transition-colors disabled:bg-rose-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatBubble = document.getElementById('chat-bubble');
        const chatWidget = document.getElementById('chat-widget');
        const closeWidgetBtn = document.getElementById('close-widget');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const imageUploadInput = document.getElementById('image-upload');

        const API_KEY = ""; // Use "" for automated key injection
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        let messages = [];
        let conversationState = { mode: 'normal', data: {} };

        const initialSuggestions = [
            { text: 'What are the hours?', action: 'faq' },
            { text: 'How much are tickets?', action: 'faq' },
            { text: 'âœ¨ Plan My Visit', action: 'plan_visit_start' },
        ];

        // --- Main Functions ---

        async function getGeminiResponse(prompt, imageBase64 = null) {
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            if (imageBase64) {
                payload.contents[0].parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: imageBase64
                    }
                });
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    console.error("API Error Response:", await response.text());
                    return "My apologies, but I'm having a little trouble connecting to my brain right now. Please try again in a moment.";
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "I seem to be experiencing a technical issue. Please try your request again later.";
            }
        }

        function getLocalResponse(userInput) {
            const lowerInput = userInput.toLowerCase();
            if (lowerInput.includes('hour') || lowerInput.includes('open') || lowerInput.includes('close')) return "We are open Wednesday to Sunday from 9am to 5pm, and we have late hours on Fridays until 9pm. We are closed on Mondays and Tuesdays.";
            if (lowerInput.includes('ticket') || lowerInput.includes('price') || lowerInput.includes('cost') || lowerInput.includes('admission')) return "General admission for adults is $18. Youth (ages 3-17) are $8. Members and children 2 and under are free. We also have special discounts, like $5 admission on Fridays after 5pm.";
            return null;
        }

        // --- UI Rendering ---

        function renderMessages() {
            messagesContainer.innerHTML = '';
            messages.forEach(msg => {
                const wrapper = document.createElement('div');
                wrapper.className = `flex mb-4 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const element = document.createElement('div');
                element.className = `p-3 rounded-lg max-w-xs md:max-w-md ${msg.sender === 'user' ? 'bg-rose-700 text-white' : 'bg-gray-200 text-gray-800'}`;
                element.innerHTML = msg.text.replace(/\n/g, '<br>'); // Support newlines in response

                wrapper.appendChild(element);
                messagesContainer.appendChild(wrapper);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderSuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            suggestions.forEach(suggestion => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip text-sm border border-gray-300 rounded-full px-3 py-1';
                chip.textContent = suggestion.text;
                chip.onclick = () => handleSuggestionClick(suggestion);
                suggestionsContainer.appendChild(chip);
            });
        }

        function addMessage(sender, text) {
            messages.push({ sender, text });
            renderMessages();
        }

        // --- Event Handlers & Logic ---

        async function handleSendMessage(userInput) {
            if (!userInput.trim()) return;

            addMessage('user', userInput);
            messageInput.value = '';
            renderSuggestions([]); // Clear suggestions on send

            const typingIndicator = showTypingIndicator();
            
            // --- CONVERSATION LOGIC ---
            if (conversationState.mode === 'plan_visit_duration') {
                conversationState.data.duration = userInput;
                addMessage('bot', "Great! And what are you most interested in seeing? (e.g., 'the gardens', 'modern art', 'a little bit of everything')");
                conversationState.mode = 'plan_visit_interests';
            } else if (conversationState.mode === 'plan_visit_interests') {
                conversationState.data.interests = userInput;
                addMessage('bot', "Perfect! Let me craft a personalized plan for you. One moment...");
                await generateItinerary();
                resetConversation();
            } else {
                // Check for fast, local responses first
                const localResponse = getLocalResponse(userInput);
                if (localResponse) {
                    addMessage('bot', localResponse);
                    renderSuggestions(initialSuggestions);
                } else {
                     // Fallback to Gemini for general queries
                    const systemPrompt = "You are a helpful and friendly virtual assistant for the Philbrook Museum of Art. Answer the user's question concisely and accurately based on general knowledge about the museum. If you don't know, say so politely.";
                    const fullPrompt = `${systemPrompt}\n\nUser question: "${userInput}"`;
                    const response = await getGeminiResponse(fullPrompt);
                    addMessage('bot', response);
                    renderSuggestions(initialSuggestions);
                }
            }
            typingIndicator.remove();
        }
        
        function handleSuggestionClick(suggestion) {
            if (suggestion.action === 'faq') {
                handleSendMessage(suggestion.text);
            } else if (suggestion.action === 'plan_visit_start') {
                conversationState.mode = 'plan_visit_duration';
                addMessage('user', 'âœ¨ Plan My Visit');
                addMessage('bot', "I can certainly help with that! To create the best plan for you, how long do you think your visit will be? (e.g., '2 hours', 'half a day')");
                renderSuggestions([]);
            }
        }

        async function generateItinerary() {
            const typingIndicator = showTypingIndicator();
            const { duration, interests } = conversationState.data;
            const systemPrompt = `You are a friendly tour guide for the Philbrook Museum of Art. Create a personalized itinerary for a visitor with the following preferences:\n- Visit Duration: ${duration}\n- Interests: ${interests}\n\nKeep the tone enthusiastic and helpful. Structure the plan with clear time suggestions or steps. Mention both the art galleries and the gardens. The museum is open Wed-Sun 9am-5pm, and until 9pm on Fridays.`;
            const itinerary = await getGeminiResponse(systemPrompt);
            typingIndicator.remove();
            addMessage('bot', itinerary);
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            addMessage('user', '<em>Uploaded an image of an artwork...</em>');
            const typingIndicator = showTypingIndicator();
            renderSuggestions([]);

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const prompt = "You are an expert art historian at the Philbrook Museum. A visitor has sent this image. Please identify the artwork if possible (title, artist, year) and share one or two interesting facts about it. If you cannot identify it, politely say you don't recognize it but encourage the visitor to find a staff member for more information.";
                
                const response = await getGeminiResponse(prompt, base64Data);
                typingIndicator.remove();
                addMessage('bot', response);
                renderSuggestions(initialSuggestions);
            };
            reader.readAsDataURL(file);
            imageUploadInput.value = ''; // Reset for next upload
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'flex justify-start mb-4';
            indicator.innerHTML = `<div class="bg-gray-200 text-gray-800 p-3 rounded-lg"><span class="animate-pulse">...</span></div>`;
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return indicator;
        }
        
        function resetConversation() {
            conversationState = { mode: 'normal', data: {} };
            renderSuggestions(initialSuggestions);
        }

        function toggleChatWidget() {
            chatWidget.classList.toggle('chat-widget-hidden');
            chatWidget.classList.toggle('chat-widget-visible');
            if (chatWidget.classList.contains('chat-widget-visible') && messages.length === 0) {
                 addMessage('bot', 'Welcome to Philbrook! How can I help you today?');
                 renderSuggestions(initialSuggestions);
            }
        }
        
        // --- Initial Setup ---
        chatBubble.addEventListener('click', toggleChatWidget);
        closeWidgetBtn.addEventListener('click', toggleChatWidget);
        sendButton.addEventListener('click', () => handleSendMessage(messageInput.value));
        messageInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleSendMessage(messageInput.value));
        imageUploadInput.addEventListener('change', handleImageUpload);
    </script>
</body>
</html>

